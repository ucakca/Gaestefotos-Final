'use client';

import { useEffect, useRef, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';

// v0-Style Components
import EventHero from '@/components/e3/EventHero';
import PhotoGrid from '@/components/e3/PhotoGrid';
import PhotoLightbox from '@/components/e3/PhotoLightbox';
import UploadModal from '@/components/e3/UploadModal';
import AlbumFilter from '@/components/e3/AlbumFilter';
import BottomNav from '@/components/e3/BottomNav';
import ChallengesTab from '@/components/e3/tabs/ChallengesTab';
import GuestbookTab from '@/components/e3/tabs/GuestbookTab';
import InfoTab from '@/components/e3/tabs/InfoTab';

// Existing components
import StoriesBar from '@/components/guest/StoriesBar';
import { Centered } from '@/components/ui/Centered';
import { ErrorState } from '@/components/ui/ErrorState';
import { FullPageLoader } from '@/components/ui/FullPageLoader';
import { PasswordGate } from '@/components/ui/PasswordGate';

// Hooks & Utils
import { useGuestEventData } from '@/hooks/useGuestEventData';
import { useStoriesViewer } from '@/hooks/useStoriesViewer';
import api, { formatApiError } from '@/lib/api';
import { useAuthStore } from '@/store/authStore';
import { useToastStore } from '@/store/toastStore';
import { Photo } from '@gaestefotos/shared';

const StoryViewer = dynamic(() => import('@/components/guest/StoryViewer'), { ssr: false });

/**
 * /e3/[slug] - v0-Style Event Guest Gallery
 * 
 * Modern Instagram/Pinterest-style photo gallery with:
 * - EventHero with cover & avatar
 * - Photo Grid (Masonry)
 * - Photo Lightbox with comments
 * - Upload Modal
 * - Album Filter
 * - Bottom Navigation (Feed, Challenges, Guestbook, Info)
 * - Stories integration
 */

export default function EventPageV3() {
  const params = useParams();
  const router = useRouter();
  const slug = params.slug as string;

  // Tab state
  const [activeTab, setActiveTab] = useState<'feed' | 'challenges' | 'guestbook' | 'info'>('feed');
  const [selectedAlbum, setSelectedAlbum] = useState<string | null>(null);
  const [selectedPhotoIndex, setSelectedPhotoIndex] = useState<number | null>(null);
  const [showUploadModal, setShowUploadModal] = useState(false);

  // Auth refs
  const didInitAuthRef = useRef(false);
  const didInitAuthFromUrlRef = useRef(false);
  const didInitCohostInviteRef = useRef(false);
  const didAcceptCohostInviteRef = useRef(false);
  const { isAuthenticated, loadUser, hasCheckedAuth, loading: authLoading } = useAuthStore();
  const { showToast } = useToastStore();

  // Load event data
  const {
    event,
    categories,
    filteredPhotos,
    challenges,
    featuresConfig,
    hostName,
    isStorageLocked,
    uploadDisabled,
    uploadDisabledReason,
    loading,
    error,
    passwordRequired,
    password,
    setPassword,
    passwordError,
    handlePasswordSubmit,
    hasMore,
    loadingMore,
    loadMore,
    reloadPhotos,
    inviteExchangeBump,
  } = useGuestEventData(slug, selectedAlbum);

  // Stories
  const {
    stories,
    selectedStoryIndex,
    setSelectedStoryIndex,
    storyProgress,
    onStoryPrev,
    onStoryNext,
    onStoryPause,
    onStoryResume,
    reloadStories,
  } = useStoriesViewer(event?.id ?? null, inviteExchangeBump);

  // Auth initialization (from /e2/)
  useEffect(() => {
    if (didInitAuthRef.current) return;
    didInitAuthRef.current = true;
    loadUser();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (didInitAuthFromUrlRef.current) return;
    didInitAuthFromUrlRef.current = true;

    try {
      if (typeof window === 'undefined') return;

      const url = new URL(window.location.href);
      const tokenFromUrl = url.searchParams.get('token');
      if (!tokenFromUrl) return;

      try {
        sessionStorage.setItem('token', tokenFromUrl);
        localStorage.removeItem('token');
      } catch {
      }

      url.searchParams.delete('token');
      window.history.replaceState(null, '', url.pathname + url.search + url.hash);

      loadUser();
    } catch {
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (didInitCohostInviteRef.current) return;
    didInitCohostInviteRef.current = true;

    try {
      if (typeof window === 'undefined') return;

      const url = new URL(window.location.href);
      const token = url.searchParams.get('cohostInvite');
      if (token) {
        try {
          sessionStorage.setItem('cohost_invite_token', token);
        } catch {
        }
        url.searchParams.delete('cohostInvite');
        window.history.replaceState(null, '', url.pathname + url.search + url.hash);
      }
    } catch {
    }
  }, []);

  useEffect(() => {
    if (!hasCheckedAuth || authLoading) return;
    if (typeof window === 'undefined') return;

    let token: string | null = null;
    try {
      token = sessionStorage.getItem('cohost_invite_token');
    } catch {
      token = null;
    }

    if (!token) return;

    if (!isAuthenticated) {
      const returnUrl = window.location.pathname + window.location.search + window.location.hash;
      const kaufUrl = new URL('https://xn--gstefotos-v2a.com/register/');
      kaufUrl.searchParams.set('gfReturnUrl', returnUrl);
      window.location.href = kaufUrl.toString();
    }
  }, [hasCheckedAuth, authLoading, isAuthenticated, router]);

  useEffect(() => {
    if (didAcceptCohostInviteRef.current) return;
    if (!event?.id) return;
    if (!hasCheckedAuth || authLoading) return;
    if (!isAuthenticated) return;

    let token: string | null = null;
    try {
      token = sessionStorage.getItem('cohost_invite_token');
    } catch {
      token = null;
    }
    if (!token) return;

    didAcceptCohostInviteRef.current = true;

    (async () => {
      try {
        await api.post('/cohosts/accept', { inviteToken: token });
        try {
          sessionStorage.removeItem('cohost_invite_token');
        } catch {
        }
        showToast('Co-Host Einladung angenommen', 'success');
      } catch (e: any) {
        try {
          sessionStorage.removeItem('cohost_invite_token');
        } catch {
        }
        showToast(formatApiError(e), 'error');
      }
    })();
  }, [event?.id, hasCheckedAuth, authLoading, isAuthenticated, showToast]);

  // Loading state
  if (loading) {
    return <FullPageLoader label="Laden..." />;
  }

  // Error state
  if (error || !event) {
    return <ErrorState message={error || 'Event nicht gefunden'} />;
  }

  // Password gate
  if (passwordRequired) {
    return (
      <Centered>
        <PasswordGate
          password={password}
          onPasswordChange={setPassword}
          passwordError={passwordError}
          onSubmit={handlePasswordSubmit}
        />
      </Centered>
    );
  }

  // Photo click handler
  const handlePhotoClick = (photo: Photo, index: number) => {
    setSelectedPhotoIndex(index);
  };

  // Lightbox navigation
  const handleNextPhoto = () => {
    if (selectedPhotoIndex !== null && selectedPhotoIndex < filteredPhotos.length - 1) {
      setSelectedPhotoIndex(selectedPhotoIndex + 1);
    }
  };

  const handlePrevPhoto = () => {
    if (selectedPhotoIndex !== null && selectedPhotoIndex > 0) {
      setSelectedPhotoIndex(selectedPhotoIndex - 1);
    }
  };

  // Upload success handler
  const handleUploadSuccess = () => {
    reloadPhotos();
    setShowUploadModal(false);
    showToast('Fotos erfolgreich hochgeladen', 'success');
  };

  // Story creation handler
  const handleStoryCreated = () => {
    reloadStories();
    reloadPhotos();
  };

  // Event URL for sharing
  const eventUrl = typeof window !== 'undefined' ? window.location.href : '';

  // Get design config for avatar/cover
  const designConfig = (event.designConfig as any) || {};
  const coverImageStoragePath = designConfig.coverImageStoragePath;
  const profileImageStoragePath = designConfig.profileImageStoragePath;
  const coverImage = coverImageStoragePath 
    ? `/api/events/${event.id}/design-image/cover/${encodeURIComponent(coverImageStoragePath)}`
    : null;
  const profileImage = profileImageStoragePath
    ? `/api/events/${event.id}/design-image/profile/${encodeURIComponent(profileImageStoragePath)}`
    : null;

  return (
    <main
      
      className="relative min-h-screen bg-background pb-24 overflow-y-auto"
    >
      {/* Sticky Header */}
      <StickyHeader
        hostAvatar={profileImage || '/placeholder.svg'}
        eventTitle={event.title}
        hostName={hostName || 'Host'}
        isVisible={isHeaderVisible && activeTab === 'feed' && !isInitialLoading}
        onScrollToTop={scrollToTop}
        onSlideshow={() => setSlideshowOpen(true)}
        onShare={() => setQrCodeOpen(true)}
      />

      {/* Pull to Refresh Indicator */}
      <PullToRefreshIndicator
      />

      {/* Content with pull offset */}
        {activeTab === 'feed' && (
          <>
            {isInitialLoading ? (
              <>
                <HeroSkeleton />
                <AlbumFilterSkeleton />
                <PhotoSkeleton count={8} className="py-4" />
              </>
            ) : (
              <>
                {/* Event Hero */}
                <EventHero
                  event={event}
                  hostName={hostName}
                  coverImage={coverImage}
                  profileImage={profileImage}
                  photoCount={filteredPhotos.length}
                  guestCount={event.maxGuests || 0}
                  hasStories={Array.isArray(stories) && stories.length > 0}
                  onProfileClick={() => {
                    if (Array.isArray(stories) && stories.length > 0) {
                      setSelectedStoryIndex(0);
                    }
                  }}
                  onAddStory={
                    !uploadDisabled && !isStorageLocked
                      ? handleStoryCreated
                      : undefined
                  }
                  isStorageLocked={isStorageLocked}
                  uploadDisabled={uploadDisabled}
                  uploadDisabledReason={uploadDisabledReason}
                  onShare={() => setQrCodeOpen(true)}
                />

                {/* Album Filter */}
                <AlbumFilter
                  categories={categories.map((cat) => ({
                    id: cat.id,
                    name: cat.name,
                    icon: cat.iconKey || undefined,
                    photoCount: 0,
                  }))}
                  selectedAlbum={selectedAlbum}
                  onAlbumSelect={setSelectedAlbum}
                  totalPhotos={filteredPhotos.length}
                  className="sticky top-0 z-30 bg-background/95 backdrop-blur-sm border-b mt-2"
                />

                {/* Photo Grid */}
                <PhotoGrid
                  photos={filteredPhotos as any[]}
                  eventId={event.id}
                  eventSlug={slug}
                  allowDownloads={featuresConfig?.allowDownloads !== false}
                  allowComments={featuresConfig?.allowComments !== false}
                  onPhotoClick={handlePhotoClick}
                  onUploadSuccess={reloadPhotos}
                  hasMore={hasMore}
                  onLoadMore={loadMore}
                  loadingMore={loadingMore}
                  isStorageLocked={isStorageLocked}
                  uploadDisabled={uploadDisabled}
                  className="py-4"
                />
              </>
            )}
          </>
        )}
        {activeTab === 'challenges' && (
          <ChallengesTab
            challenges={challenges || []}
            eventId={event.id}
          />
        )}

        {activeTab === 'guestbook' && (
          <GuestbookTab
            entries={[]} // Would need guestbook API
            eventId={event.id}
            onEntrySubmit={reloadPhotos}
          />
        )}

        {activeTab === 'info' && (
          <InfoTab
            event={event}
            hostName={hostName}
          />
        )}
      </div>

      {/* Jump to Top Button */}
      <JumpToTop
        isVisible={showJumpToTop && activeTab === 'feed' && !isInitialLoading}
        onClick={scrollToTop}
      />

      {/* Upload FAB */}
      <UploadFAB
        isVisible={activeTab === 'feed' && !isInitialLoading && !uploadDisabled && !isStorageLocked}
        onUploadPhoto={() => setShowUploadModal(true)}
        onTakePhoto={() => setShowUploadModal(true)}
        onRecordVideo={() => setShowUploadModal(true)}
      />

      {/* QR Code Share Modal */}
      <QRCodeShare
        eventUrl={eventUrl}
        eventTitle={event.title}
        isOpen={qrCodeOpen}
        onClose={() => setQrCodeOpen(false)}
      />

      {/* Slideshow Mode */}
      <SlideshowMode
        photos={filteredPhotos}
        isOpen={slideshowOpen}
        onClose={() => setSlideshowOpen(false)}
      />

      {/* Bottom Navigation */}
      <BottomNav
        activeTab={activeTab}
        onTabChange={setActiveTab}
        challengeCount={challenges?.filter((c: any) => c?.isActive).length || 0}
        guestbookCount={0}
      />

      {/* Photo Lightbox */}
      <PhotoLightbox
        photos={filteredPhotos as any[]}
        selectedIndex={selectedPhotoIndex}
        eventSlug={slug}
        allowDownloads={featuresConfig?.allowDownloads !== false}
        allowComments={featuresConfig?.allowComments !== false}
        onClose={() => setSelectedPhotoIndex(null)}
        onNext={handleNextPhoto}
        onPrev={handlePrevPhoto}
      />

      {/* Upload Modal */}
      <UploadModal
        isOpen={showUploadModal}
        onClose={() => setShowUploadModal(false)}
      />
    </main>
  );
}
