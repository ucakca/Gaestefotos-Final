#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

if [ "${SKIP_E2E_HOOK:-}" = "1" ]; then
  echo "[pre-push] SKIP_E2E_HOOK=1 set; skipping e2e:stable"
  exit 0
fi

if [ "${FORCE_E2E_HOOK:-}" != "1" ]; then
  if [ ! -d "${PLAYWRIGHT_BROWSERS_PATH:-$HOME/.cache/ms-playwright}" ]; then
    echo "[pre-push] Playwright browsers not installed; skipping e2e:stable (set FORCE_E2E_HOOK=1 to run)"
    exit 0
  fi
fi

# Check if production servers are running (ports 3002 for frontend, 8001 for backend)
frontend_running=$(ss -tlnp 2>/dev/null | grep -c ':3002' || true)
backend_running=$(ss -tlnp 2>/dev/null | grep -c ':8001' || true)

if [ "$frontend_running" -gt 0 ] && [ "$backend_running" -gt 0 ]; then
  echo "[pre-push] Production servers detected on ports 3002/8001; running e2e:stable against existing servers..."
  E2E_START_WEB_SERVER=false E2E_BASE_URL=http://localhost:3002 E2E_API_URL=http://localhost:8001 pnpm run -s e2e:stable
else
  echo "[pre-push] running e2e:stable..."
  pnpm run -s e2e:stable
fi
