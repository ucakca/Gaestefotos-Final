// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String   // hashed
  role      UserRole @default(HOST)
  wordpressUserId Int?     @unique
  twoFactorEnabled Boolean @default(false)
  twoFactorPending Boolean @default(false)
  twoFactorSecretEncrypted String?
  twoFactorSecretIv String?
  twoFactorSecretTag String?
  twoFactorRecoveryCodesHashed Json?
  twoFactorSetupAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
  eventMembers EventMember[]
  apiKeys ApiKey[]
  impersonationAuditsAsAdmin ImpersonationAuditLog[] @relation("ImpersonationAuditAdmin")
  impersonationAuditsAsTarget ImpersonationAuditLog[] @relation("ImpersonationAuditTarget")

  @@map("users")
}

enum UserRole {
  ADMIN
  HOST
}

enum EventMemberRole {
  COHOST
}

model Event {
  id                     String   @id @default(uuid())
  hostId                 String
  slug                   String   @unique
  eventCode              String?  @unique
  title                  String
  dateTime               DateTime?
  locationName           String?
  locationGoogleMapsLink String?
  password               String?  // hashed
  isActive               Boolean  @default(true)
  deletedAt              DateTime?
  purgeAfter             DateTime?
  
  // JSONB für flexible Konfiguration
  designConfig           Json?    @default("{}")
  featuresConfig         Json     @default("{\"showGuestlist\":false,\"mysteryMode\":false,\"allowUploads\":true,\"moderationRequired\":false,\"allowDownloads\":true}")
  guestbookHostMessage   String?  @db.Text // Host-Nachricht im Gästebuch (Standardtext)
  profileDescription     String?  @db.Text
  designAssetsBytes      BigInt?  // optional aggregate for logo/profile/cover uploads
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  host      User       @relation(fields: [hostId], references: [id], onDelete: Cascade)
  members   EventMember[]
  guests    Guest[]
  photos    Photo[]
  videos    Video[]
  categories Category[]
  stories   Story[]
  trafficStats EventTrafficStat[]
  guestbookEntries GuestbookEntry[]
  guestbookPhotoUploads GuestbookPhotoUpload[]
  guestbookAudioUploads GuestbookAudioUpload[]
  challenges Challenge[]
  entitlements EventEntitlement[]
  invitations Invitation[]
  reminderLogs EventReminderLog[]
  invoiceRecords InvoiceRecord[]
  faceSearchConsents FaceSearchConsent[]
  faceSearchConsentAudits FaceSearchConsentAuditLog[]

  @@index([slug])
  @@index([hostId])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("events")
}

model EventMember {
  id        String          @id @default(uuid())
  eventId   String
  userId    String
  role      EventMemberRole @default(COHOST)
  permissions Json          @default("{}")
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_members")
}

model EventTrafficStat {
  id         String   @id @default(uuid())
  eventId    String
  source     String
  count      Int      @default(0)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, source])
  @@index([eventId])
  @@index([source])
  @@map("event_traffic_stats")
}

model EventReminderLog {
  id        String   @id @default(uuid())
  eventId   String
  kind      String
  daysBefore Int
  sentAt    DateTime @default(now())
  storageEndsAt DateTime?

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, kind, daysBefore])
  @@index([eventId])
  @@index([kind])
  @@index([sentAt])
  @@map("event_reminder_logs")
}

model AppSetting {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

enum QaLogLevel {
  IMPORTANT
  DEBUG
}

model QaLogEvent {
  id        String     @id @default(uuid())
  level     QaLogLevel @default(IMPORTANT)
  type      String
  message   String?
  data      Json?
  userId    String?
  userRole  String?
  eventId   String?
  path      String?
  method    String?
  userAgent String?
  ipHash    String?
  createdAt DateTime   @default(now())

  @@index([createdAt])
  @@index([level])
  @@index([type])
  @@index([eventId])
  @@index([userId])
  @@map("qa_log_events")
}

enum EntitlementStatus {
  ACTIVE
  REPLACED
  CANCELLED
}

model EventEntitlement {
  id              String            @id @default(uuid())
  eventId         String
  wpUserId        Int
  status          EntitlementStatus @default(ACTIVE)
  source          String
  wcOrderId       String?
  wcProductId     String?
  wcSku           String?
  storageLimitBytes BigInt?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([wpUserId])
  @@index([status])
  @@map("event_entitlements")
}

enum PackageDefinitionType {
  BASE
  UPGRADE
}

model WooWebhookReceipt {
  id        String   @id @default(uuid())
  wcOrderId String   @unique @map("wc_order_id")
  createdAt DateTime @default(now())

  @@index([wcOrderId])
  @@map("woo_webhook_receipts")
}

enum WooWebhookProvider {
  WOOCOMMERCE
}

enum WooWebhookLogStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
  FORBIDDEN
}

model WooWebhookEventLog {
  id           String            @id @default(uuid())
  provider     WooWebhookProvider @default(WOOCOMMERCE)
  topic        String
  wcOrderId    String?
  eventCode    String?
  eventId      String?
  wpUserId     Int?
  wcProductId  String?
  wcSku        String?
  skus         String[]          @default([])
  signatureOk  Boolean           @default(false)
  status       WooWebhookLogStatus @default(RECEIVED)
  reason       String?
  error        String?
  payloadHash  String?
  payload      Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([provider])
  @@index([topic])
  @@index([wcOrderId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
  @@map("woo_webhook_event_logs")
}

model PackageDefinition {
  id                    String                @id @default(uuid())
  sku                   String                @unique
  name                  String
  type                  PackageDefinitionType @default(BASE)
  resultingTier         String
  upgradeFromTier       String?
  isActive              Boolean               @default(true)
  
  // === STORAGE & DURATION ===
  storageLimitBytes     BigInt?               // null = unlimited
  storageLimitPhotos    Int?                  // Alternative: Foto-Anzahl statt Bytes
  storageDurationDays   Int?                  // Online-Laufzeit in Tagen
  
  // === FEATURE FLAGS ===
  allowVideoUpload      Boolean               @default(false)
  allowStories          Boolean               @default(false)
  allowPasswordProtect  Boolean               @default(false)
  allowGuestbook        Boolean               @default(false)
  allowZipDownload      Boolean               @default(false)
  allowBulkOperations   Boolean               @default(false)
  allowLiveWall         Boolean               @default(false)
  allowFaceSearch       Boolean               @default(false)  // "Finde meine Fotos"
  allowGuestlist        Boolean               @default(false)
  allowFullInvitation   Boolean               @default(false)  // Nicht-beschränkte Einladungsseite
  allowCoHosts          Boolean               @default(false)
  isAdFree              Boolean               @default(false)  // Werbefrei
  
  // === LIMITS ===
  maxCategories         Int?                  // null = unlimited
  maxChallenges         Int?                  // null = unlimited
  maxZipDownloadPhotos  Int?                  // z.B. 200 für Basic
  maxCoHosts            Int?                  // 0/1/3/null(unlimited)
  
  // === DISPLAY & PRICING ===
  displayOrder          Int                   @default(0)
  priceEurCents         Int?                  // Preis in Cents (2900 = 29€)
  description           String?               @db.Text
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([sku])
  @@index([type])
  @@index([isActive])
  @@index([displayOrder])
  @@map("package_definitions")
}

model Guest {
  id                 String      @id @default(uuid())
  eventId            String
  firstName          String
  lastName           String
  email              String?
  status             GuestStatus @default(PENDING)
  dietaryRequirements String?    @db.Text
  plusOneCount       Int         @default(0)
  accessToken        String      @unique @default(uuid())
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  photos Photo[]
  videos Video[]
  challengeCompletions ChallengeCompletion[]

  @@index([eventId])
  @@index([accessToken])
  @@map("guests")
}

enum GuestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Photo {
  id         String      @id @default(uuid())
  eventId    String
  guestId    String?
  categoryId String?
  storagePath String        // Optimized (1920px) - für Galerie-Ansicht
  storagePathOriginal String? // Original (volle Qualität) - für Host-Download
  storagePathThumb String?    // Thumbnail (300px) - für Previews
  url        String?
  status     PhotoStatus @default(PENDING)
  deletedAt  DateTime?
  purgeAfter DateTime?
  sizeBytes  BigInt?
  isStoryOnly Boolean    @default(false)
  
  // Metadaten
  title       String?
  description String?   @db.Text
  tags        String[]  @default([])
  uploadedBy  String?   // Name des Uploaders (wenn kein Gast)
  views       Int       @default(0)
  latitude    Float?
  longitude   Float?
  exifData    Json?     // EXIF-Metadaten als JSON
  
  // Duplikat-Erkennung
  perceptualHash String?  // Perceptual hash für ähnliche Bilder
  md5Hash        String?  // MD5 hash für exakte Duplikate
  duplicateGroupId String? // ID der Duplikat-Gruppe
  isBestInGroup   Boolean @default(false) // Bestes Foto in der Gruppe
  qualityScore    Float?  // Qualitäts-Score (für Beste-Foto-Auswahl)
  
  // Gesichtserkennung
  faceCount       Int?    // Anzahl erkannte Gesichter
  faceData        Json?   // Gesichtserkennungs-Daten (Positionen, etc.)
  
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  event    Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest    Guest?    @relation(fields: [guestId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  likes    PhotoLike[]
  comments PhotoComment[]
  votes    PhotoVote[]
  stories  Story[]
  challengeCompletions ChallengeCompletion[]

  @@index([eventId])
  @@index([status])
  @@index([guestId])
  @@index([categoryId])
  @@index([tags])
  @@index([duplicateGroupId])
  @@index([perceptualHash])
  @@index([md5Hash])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("photos")
}

model Category {
  id                  String    @id @default(uuid())
  eventId             String
  name                String
  iconKey             String?
  order               Int        @default(0)
  isVisible           Boolean    @default(true)  // Sichtbar für Gäste
  uploadLocked        Boolean    @default(false) // Upload gesperrt
  uploadLockUntil     DateTime?  // Upload gesperrt bis Datum
  challengeEnabled    Boolean   @default(false) // Challenge aktiviert
  challengeDescription String?   @db.Text        // Challenge-Beschreibung
  dateTime            DateTime?  // Datum & Uhrzeit für dieses Album
  startAt             DateTime?  // Smart Album Start (Zeitfenster)
  endAt               DateTime?  // Smart Album Ende (Zeitfenster)
  locationName        String?    // Ort für dieses Album
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  photos Photo[]
  videos Video[]
  challenges Challenge[]

  @@index([eventId])
  @@index([isVisible])
  @@map("categories")
}

enum PhotoStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

model PhotoLike {
  id        String   @id @default(uuid())
  photoId   String
  guestId   String?
  ipAddress String?  // Fallback für anonyme Likes
  userAgent String?  // Browser-Info
  reactionType String? // z.B. "heart", "laugh", "wow", "fire", "clap"
  createdAt DateTime @default(now())

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, ipAddress]) // Verhindert doppelte Likes von gleicher IP
  @@index([photoId])
  @@map("photo_likes")
}

model PhotoComment {
  id        String   @id @default(uuid())
  photoId   String
  guestId   String?
  authorName String  // Fallback wenn kein Gast
  comment   String   @db.Text
  status    CommentStatus @default(PENDING) // Moderation
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([photoId])
  @@index([status])
  @@map("photo_comments")
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

model PhotoVote {
  id        String   @id @default(uuid())
  photoId   String
  guestId   String?
  ipAddress String?  // Fallback für anonyme Votes
  rating    Int      // 1-5 Sterne
  createdAt DateTime @default(now())

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, ipAddress]) // Verhindert doppelte Votes
  @@index([photoId])
  @@map("photo_votes")
}

model Story {
  id        String   @id @default(uuid())
  eventId   String
  photoId   String?
  videoId   String?
  isActive  Boolean  @default(true) // Gast kann Story aktivieren/deaktivieren
  expiresAt DateTime // 24 Stunden nach Upload
  views     Int      @default(0)
  createdAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  photo Photo? @relation(fields: [photoId], references: [id], onDelete: Cascade)
  video Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([photoId])
  @@index([videoId])
  @@map("stories")
}

model GuestbookEntry {
  id        String   @id @default(uuid())
  eventId   String
  guestId   String?
  authorName String
  message   String   @db.Text
  photoUrl  String?  // Optional: Foto zur Nachricht
  photoStoragePath String? // Storage path für das Foto
  photoSizeBytes BigInt?
  audioUrl  String?  // Optional: Audio zur Nachricht
  audioStoragePath String? // Storage path für das Audio
  audioMimeType String?
  audioDurationMs Int?
  audioSizeBytes BigInt?
  isPublic  Boolean  @default(true) // Ob der Eintrag im Feed erscheint
  status    EntryStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@index([isPublic])
  @@map("guestbook_entries")
}

model GuestbookPhotoUpload {
  id          String   @id @default(uuid())
  eventId     String
  storagePath String
  sizeBytes   BigInt
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  claimedAt   DateTime?

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([storagePath])
  @@index([expiresAt])
  @@index([claimedAt])
  @@map("guestbook_photo_uploads")
}

model GuestbookAudioUpload {
  id          String   @id @default(uuid())
  eventId     String
  storagePath String
  mimeType    String
  sizeBytes   BigInt
  durationMs  Int?
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  claimedAt   DateTime?

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([storagePath])
  @@index([expiresAt])
  @@index([claimedAt])
  @@map("guestbook_audio_uploads")
}

enum EntryStatus {
  PENDING
  APPROVED
  REJECTED
}

model Video {
  id         String      @id @default(uuid())
  eventId    String
  guestId    String?
  categoryId String?
  storagePath String
  url        String?
  status     VideoStatus @default(PENDING)
  deletedAt  DateTime?
  purgeAfter DateTime?
  sizeBytes  BigInt?
  isStoryOnly Boolean    @default(false)
  scanStatus String?
  scannedAt  DateTime?
  scanError  String?
  
  // Metadaten
  title       String?
  description String?   @db.Text
  tags        String[]  @default([])
  uploadedBy  String?   // Name des Uploaders (wenn kein Gast)
  views       Int       @default(0)
  duration    Int?      // Dauer in Sekunden
  thumbnailPath String?  // Pfad zum Thumbnail
  
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  event    Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest    Guest?    @relation(fields: [guestId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  stories  Story[]

  @@index([eventId])
  @@index([status])
  @@index([guestId])
  @@index([categoryId])
  @@index([tags])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("videos")
}

enum VideoStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

model Challenge {
  id          String   @id @default(uuid())
  eventId     String
  categoryId String?  // null = globale Challenge, sonst Album-spezifisch
  title       String
  description String?  @db.Text
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  isVisible   Boolean  @default(true) // Sichtbarkeit des Challenge-Fotos
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  category  Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  completions ChallengeCompletion[]

  @@index([eventId])
  @@index([categoryId])
  @@index([isActive])
  @@map("challenges")
}

model ChallengeCompletion {
  id          String   @id @default(uuid())
  challengeId String
  photoId     String   @unique // Pro Challenge nur ein Foto
  guestId     String?
  uploaderName String?  // Fallback für anonyme Uploads
  ratingCount Int      @default(0)
  averageRating Float?  // Durchschnittsbewertung (1-5)
  completedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  guest     Guest?   @relation(fields: [guestId], references: [id], onDelete: SetNull)
  ratings   ChallengeRating[]

  @@index([challengeId])
  @@index([photoId])
  @@index([guestId])
  @@map("challenge_completions")
}

model ChallengeRating {
  id          String   @id @default(uuid())
  completionId String
  raterGuestId String?
  raterName   String?  // Fallback für anonyme Bewertungen
  ipAddress   String?  // Fallback für anonyme Bewertungen
  rating      Int      // 1-5 Sterne
  createdAt   DateTime @default(now())

  completion ChallengeCompletion @relation(fields: [completionId], references: [id], onDelete: Cascade)

  @@unique([completionId, ipAddress]) // Verhindert doppelte Bewertungen
  @@index([completionId])
  @@map("challenge_ratings")
}

model Invitation {
  id           String   @id @default(uuid())
  eventId       String
  slug          String   @unique
  name          String
  config        Json?    @default("{}")
  passwordHash  String?
  visibility    InvitationVisibility @default(UNLISTED)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  event        Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  shortLinks   InvitationShortLink[]
  visits       InvitationVisit[]
  rsvps        InvitationRsvp[]

  @@index([eventId])
  @@index([slug])
  @@index([visibility])
  @@index([isActive])
  @@map("invitations")
}

enum InvitationVisibility {
  UNLISTED
  PUBLIC
}

enum InvitationRsvpStatus {
  YES
  NO
  MAYBE
}

model InvitationRsvp {
  id           String               @id @default(uuid())
  invitationId String
  status       InvitationRsvpStatus
  name         String?
  ipHash       String?
  userAgent    String?
  createdAt    DateTime             @default(now())

  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@index([invitationId])
  @@index([status])
  @@index([createdAt])
  @@map("invitation_rsvps")
}

model InvitationShortLink {
  id            String   @id @default(uuid())
  invitationId  String
  code          String   @unique
  channel       String?
  createdAt     DateTime @default(now())
  lastAccessedAt DateTime?

  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  visits     InvitationVisit[]

  @@index([invitationId])
  @@index([code])
  @@map("invitation_short_links")
}

model InvitationVisit {
  id            String   @id @default(uuid())
  invitationId  String
  shortLinkId   String?
  ipHash        String?
  userAgent     String?
  createdAt     DateTime @default(now())

  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  shortLink   InvitationShortLink? @relation(fields: [shortLinkId], references: [id], onDelete: SetNull)

  @@index([invitationId])
  @@index([shortLinkId])
  @@index([createdAt])
  @@map("invitation_visits")
}

model InvitationTemplate {
  id        String   @id @default(uuid())
  slug        String    @unique
  title       String
  description String?
  html        String?   @db.Text
  text        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("invitation_templates")
}

model ImpersonationAuditLog {
  id           String   @id @default(uuid())
  adminUserId  String
  targetUserId String
  reason       String?
  ttlSeconds   Int
  ipHash       String?
  userAgent    String?
  createdAt    DateTime @default(now())

  adminUser  User @relation("ImpersonationAuditAdmin", fields: [adminUserId], references: [id], onDelete: Cascade)
  targetUser User @relation("ImpersonationAuditTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("impersonation_audit_logs")
}

enum EmailTemplateKind {
  INVITATION
  STORAGE_ENDS_REMINDER
  PHOTO_NOTIFICATION
}

model EmailTemplate {
  id        String            @id @default(uuid())
  kind      EmailTemplateKind @unique
  name      String
  subject   String
  html      String?           @db.Text
  text      String?           @db.Text
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([kind])
  @@index([isActive])
  @@map("email_templates")
}

enum CmsContentKind {
  pages
  posts
}

model CmsContentSnapshot {
  id        String         @id @default(uuid())
  kind      CmsContentKind
  slug      String
  title     String
  html      String?        @db.Text
  excerpt   String?        @db.Text
  sourceUrl String
  link      String?
  modifiedGmt String?
  fetchedAt DateTime       @default(now())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([kind, slug])
  @@index([kind])
  @@index([slug])
  @@index([fetchedAt])
  @@map("cms_content_snapshots")
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

model ApiKey {
  id           String       @id @default(uuid())
  name         String
  prefix       String       @unique
  keyHash      String       @unique
  scopes       String[]     @default([])
  status       ApiKeyStatus @default(ACTIVE)
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  createdById  String?
  revokedAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)
  audits    ApiKeyAuditLog[]

  @@index([status])
  @@index([prefix])
  @@index([createdById])
  @@index([expiresAt])
  @@map("api_keys")
}

enum ApiKeyAuditAction {
  CREATED
  REVOKED
  USED
  FAILED
}

model ApiKeyAuditLog {
  id         String           @id @default(uuid())
  apiKeyId   String?
  action     ApiKeyAuditAction
  scope      String?
  path       String?
  ipHash     String?
  userAgent  String?
  message    String?
  createdAt  DateTime         @default(now())

  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([apiKeyId])
  @@index([action])
  @@index([createdAt])
  @@map("api_key_audit_logs")
}

enum FaceSearchConsentAction {
  ACCEPTED
  REVOKED
}

model FaceSearchConsent {
  id            String   @id @default(uuid())
  eventId        String
  ipHash         String?
  userAgent      String?
  consentKey     String? // e.g. face_search_consent_v1
  noticeText     String? @db.Text
  checkboxLabel  String? @db.Text
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  audits  FaceSearchConsentAuditLog[]

  @@index([eventId])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("face_search_consents")
}

model FaceSearchConsentAuditLog {
  id            String   @id @default(uuid())
  consentId     String?
  eventId       String
  action        FaceSearchConsentAction
  ipHash        String?
  userAgent     String?
  consentKey    String?
  noticeText    String?  @db.Text
  checkboxLabel String?  @db.Text
  createdAt     DateTime @default(now())

  consent FaceSearchConsent? @relation(fields: [consentId], references: [id], onDelete: SetNull)
  event   Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([consentId])
  @@index([eventId])
  @@index([action])
  @@index([createdAt])
  @@map("face_search_consent_audit_logs")
}

enum InvoiceSource {
  WOOCOMMERCE
  MANUAL
}

enum InvoiceStatus {
  OPEN
  PAID
  VOID
  REFUNDED
}

model InvoiceRecord {
  id         String        @id @default(uuid())
  source     InvoiceSource @default(WOOCOMMERCE)
  status     InvoiceStatus @default(OPEN)
  wcOrderId  String?
  wpUserId   Int?
  eventId    String?
  currency   String        @default("EUR")
  amountCents Int
  issuedAt   DateTime      @default(now())
  payload    Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  event Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([source])
  @@index([status])
  @@index([wcOrderId])
  @@index([wpUserId])
  @@index([eventId])
  @@index([issuedAt])
  @@map("invoice_records")
}
