generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String                  @id @default(uuid())
  email                        String                  @unique
  name                         String
  password                     String
  role                         UserRole                @default(HOST)
  createdAt                    DateTime                @default(now())
  updatedAt                    DateTime                @updatedAt
  wordpressUserId              Int?                    @unique
  twoFactorEnabled             Boolean                 @default(false)
  twoFactorPending             Boolean                 @default(false)
  twoFactorRecoveryCodesHashed Json?
  twoFactorSecretEncrypted     String?
  twoFactorSecretIv            String?
  twoFactorSecretTag           String?
  twoFactorSetupAt             DateTime?
  apiKeys                      ApiKey[]
  eventMembers                 EventMember[]
  events                       Event[]
  impersonationAuditsAsAdmin   ImpersonationAuditLog[] @relation("ImpersonationAuditAdmin")
  impersonationAuditsAsTarget  ImpersonationAuditLog[] @relation("ImpersonationAuditTarget")
  partnerMemberships           PartnerMember[]

  @@map("users")
}

model Event {
  id                      String                      @id @default(uuid())
  hostId                  String
  slug                    String                      @unique
  title                   String
  dateTime                DateTime?
  locationName            String?
  locationGoogleMapsLink  String?
  designConfig            Json?                       @default("{}")
  featuresConfig          Json                        @default("{\"mysteryMode\": false, \"allowUploads\": true, \"showGuestlist\": false, \"allowDownloads\": true, \"moderationRequired\": false}")
  createdAt               DateTime                    @default(now())
  updatedAt               DateTime                    @updatedAt
  password                String?
  guestbookHostMessage    String?
  deletedAt               DateTime?
  isActive                Boolean                     @default(true)
  purgeAfter              DateTime?
  eventCode               String?                     @unique
  designAssetsBytes       BigInt?
  profileDescription      String?
  invitationDesign        Json?
  categories              Category[]
  challenges              Challenge[]
  design_projects         design_projects[]
  entitlements            EventEntitlement[]
  members                 EventMember[]
  reminderLogs            EventReminderLog[]
  trafficStats            EventTrafficStat[]
  host                    User                        @relation(fields: [hostId], references: [id], onDelete: Cascade)
  faceSearchConsentAudits FaceSearchConsentAuditLog[]
  faceSearchConsents      FaceSearchConsent[]
  guestbookAudioUploads   GuestbookAudioUpload[]
  guestbookEntries        GuestbookEntry[]
  guestbookPhotoUploads   GuestbookPhotoUpload[]
  guests                  Guest[]
  invitations             Invitation[]
  invoiceRecords          InvoiceRecord[]
  photos                  Photo[]
  stories                 Story[]
  videos                  Video[]
  visitCount              Int                         @default(0)
  wifiName                String?
  wifiPassword            String?
  mosaicWall              MosaicWall?
  partnerId               String?
  partner                 Partner?                    @relation(fields: [partnerId], references: [id])

  @@index([slug])
  @@index([hostId])
  @@index([partnerId])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("events")
}

model EventMember {
  id          String          @id @default(uuid())
  eventId     String
  userId      String
  role        EventMemberRole @default(COHOST)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  permissions Json            @default("{}")
  event       Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_members")
}

model EventTrafficStat {
  id          String   @id @default(uuid())
  eventId     String
  source      String
  count       Int      @default(0)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, source])
  @@index([eventId])
  @@index([source])
  @@map("event_traffic_stats")
}

model EventReminderLog {
  id            String    @id @default(uuid())
  eventId       String
  kind          String
  daysBefore    Int
  sentAt        DateTime  @default(now())
  storageEndsAt DateTime?
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, kind, daysBefore])
  @@index([eventId])
  @@index([kind])
  @@index([sentAt])
  @@map("event_reminder_logs")
}

model AppSetting {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

model QaLogEvent {
  id        String     @id @default(uuid())
  level     QaLogLevel @default(IMPORTANT)
  type      String
  message   String?
  data      Json?
  userId    String?
  userRole  String?
  eventId   String?
  path      String?
  method    String?
  userAgent String?
  ipHash    String?
  createdAt DateTime   @default(now())

  @@index([createdAt])
  @@index([level])
  @@index([type])
  @@index([eventId])
  @@index([userId])
  @@map("qa_log_events")
}

model EventEntitlement {
  id                String            @id @default(uuid())
  eventId           String
  wpUserId          Int
  status            EntitlementStatus @default(ACTIVE)
  source            String
  wcOrderId         String?
  wcProductId       String?
  wcSku             String?
  storageLimitBytes BigInt?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  event             Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([wpUserId])
  @@index([status])
  @@map("event_entitlements")
}

model WooWebhookReceipt {
  id        String   @id @default(uuid())
  wcOrderId String   @unique @map("wc_order_id")
  createdAt DateTime @default(now())

  @@index([wcOrderId])
  @@map("woo_webhook_receipts")
}

model WooWebhookEventLog {
  id          String              @id @default(uuid())
  provider    WooWebhookProvider  @default(WOOCOMMERCE)
  topic       String
  wcOrderId   String?
  eventCode   String?
  eventId     String?
  wpUserId    Int?
  wcProductId String?
  wcSku       String?
  skus        String[]            @default([])
  signatureOk Boolean             @default(false)
  status      WooWebhookLogStatus @default(RECEIVED)
  reason      String?
  error       String?
  payloadHash String?
  payload     Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([provider])
  @@index([topic])
  @@index([wcOrderId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
  @@map("woo_webhook_event_logs")
}

model PackageDefinition {
  id                   String                @id @default(uuid())
  sku                  String                @unique
  name                 String
  type                 PackageDefinitionType @default(BASE)
  resultingTier        String
  upgradeFromTier      String?
  storageLimitBytes    BigInt?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  storageDurationDays  Int?
  allowBulkOperations  Boolean               @default(false)
  allowCoHosts         Boolean               @default(false)
  allowFaceSearch      Boolean               @default(false)
  allowFullInvitation  Boolean               @default(false)
  allowGuestbook       Boolean               @default(false)
  allowGuestlist       Boolean               @default(false)
  allowLiveWall        Boolean               @default(false)
  allowMosaicWall      Boolean               @default(false)
  allowMosaicPrint     Boolean               @default(false)
  allowMosaicExport    Boolean               @default(false)
  allowPasswordProtect Boolean               @default(false)
  allowStories         Boolean               @default(false)
  allowVideoUpload     Boolean               @default(false)
  allowZipDownload     Boolean               @default(false)
  description          String?
  displayOrder         Int                   @default(0)
  isAdFree             Boolean               @default(false)
  maxCategories        Int?
  maxChallenges        Int?
  maxCoHosts           Int?
  maxZipDownloadPhotos Int?
  priceEurCents        Int?
  storageLimitPhotos   Int?

  @@index([sku])
  @@index([type])
  @@index([isActive])
  @@index([displayOrder])
  @@map("package_definitions")
}

model Guest {
  id                   String                @id @default(uuid())
  eventId              String
  firstName            String
  lastName             String
  email                String?
  status               GuestStatus           @default(PENDING)
  dietaryRequirements  String?
  plusOneCount         Int                   @default(0)
  accessToken          String                @unique @default(uuid())
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  challengeCompletions ChallengeCompletion[]
  event                Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)
  photos               Photo[]
  videos               Video[]

  @@index([eventId])
  @@index([accessToken])
  @@map("guests")
}

model Photo {
  id                   String               @id @default(uuid())
  eventId              String
  guestId              String?
  storagePath          String
  url                  String?
  status               PhotoStatus          @default(PENDING)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  categoryId           String?
  description          String?
  exifData             Json?
  latitude             Float?
  longitude            Float?
  tags                 String[]             @default([])
  title                String?
  uploadedBy           String?
  views                Int                  @default(0)
  duplicateGroupId     String?
  isBestInGroup        Boolean              @default(false)
  md5Hash              String?
  perceptualHash       String?
  qualityScore         Float?
  faceCount            Int?
  faceData             Json?
  deletedAt            DateTime?
  purgeAfter           DateTime?
  sizeBytes            BigInt?
  isStoryOnly          Boolean              @default(false)
  storagePathOriginal  String?
  storagePathThumb     String?
  challengeCompletions ChallengeCompletion?
  comments             PhotoComment[]
  likes                PhotoLike[]
  votes                PhotoVote[]
  category             Category?            @relation(fields: [categoryId], references: [id])
  event                Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest                Guest?               @relation(fields: [guestId], references: [id])
  stories              Story[]
  mosaicTiles          MosaicTile[]
  mosaicPrintJobs      MosaicPrintJob[]

  @@index([eventId])
  @@index([status])
  @@index([guestId])
  @@index([categoryId])
  @@index([tags])
  @@index([duplicateGroupId])
  @@index([perceptualHash])
  @@index([md5Hash])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("photos")
}

model Category {
  id                   String      @id @default(uuid())
  eventId              String
  name                 String
  order                Int         @default(0)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  challengeDescription String?
  challengeEnabled     Boolean     @default(false)
  isVisible            Boolean     @default(true)
  uploadLockUntil      DateTime?
  uploadLocked         Boolean     @default(false)
  dateTime             DateTime?
  locationName         String?
  iconKey              String?
  endAt                DateTime?
  startAt              DateTime?
  event                Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  challenges           Challenge[]
  photos               Photo[]
  videos               Video[]

  @@index([eventId])
  @@index([isVisible])
  @@map("categories")
}

model PhotoLike {
  id           String   @id @default(uuid())
  photoId      String
  guestId      String?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  reactionType String?
  photo        Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, ipAddress])
  @@index([photoId])
  @@map("photo_likes")
}

model PhotoComment {
  id         String        @id @default(uuid())
  photoId    String
  guestId    String?
  authorName String
  comment    String
  status     CommentStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  photo      Photo         @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([photoId])
  @@index([status])
  @@map("photo_comments")
}

model PhotoVote {
  id        String   @id @default(uuid())
  photoId   String
  guestId   String?
  ipAddress String?
  rating    Int
  createdAt DateTime @default(now())
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, ipAddress])
  @@index([photoId])
  @@map("photo_votes")
}

model Story {
  id        String   @id @default(uuid())
  eventId   String
  photoId   String?
  isActive  Boolean  @default(true)
  expiresAt DateTime
  views     Int      @default(0)
  createdAt DateTime @default(now())
  videoId   String?
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  photo     Photo?   @relation(fields: [photoId], references: [id], onDelete: Cascade)
  video     Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([photoId])
  @@index([videoId])
  @@map("stories")
}

model GuestbookEntry {
  id               String      @id @default(uuid())
  eventId          String
  guestId          String?
  authorName       String
  message          String
  photoUrl         String?
  status           EntryStatus @default(PENDING)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  isPublic         Boolean     @default(true)
  photoStoragePath String?
  photoSizeBytes   BigInt?
  audioDurationMs  Int?
  audioMimeType    String?
  audioSizeBytes   BigInt?
  audioStoragePath String?
  audioUrl         String?
  event            Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@index([isPublic])
  @@map("guestbook_entries")
}

model GuestbookPhotoUpload {
  id          String    @id @default(uuid())
  eventId     String
  storagePath String
  sizeBytes   BigInt
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  claimedAt   DateTime?
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([storagePath])
  @@index([expiresAt])
  @@index([claimedAt])
  @@map("guestbook_photo_uploads")
}

model GuestbookAudioUpload {
  id          String    @id @default(uuid())
  eventId     String
  storagePath String
  mimeType    String
  sizeBytes   BigInt
  durationMs  Int?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  claimedAt   DateTime?
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([storagePath])
  @@index([expiresAt])
  @@index([claimedAt])
  @@map("guestbook_audio_uploads")
}

model Video {
  id            String      @id @default(uuid())
  eventId       String
  guestId       String?
  categoryId    String?
  storagePath   String
  url           String?
  status        VideoStatus @default(PENDING)
  title         String?
  description   String?
  tags          String[]    @default([])
  uploadedBy    String?
  views         Int         @default(0)
  duration      Int?
  thumbnailPath String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?
  purgeAfter    DateTime?
  sizeBytes     BigInt?
  scanStatus    String?
  scannedAt     DateTime?
  scanError     String?
  isStoryOnly   Boolean     @default(false)
  stories       Story[]
  category      Category?   @relation(fields: [categoryId], references: [id])
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest         Guest?      @relation(fields: [guestId], references: [id])

  @@index([eventId])
  @@index([status])
  @@index([guestId])
  @@index([categoryId])
  @@index([tags])
  @@index([deletedAt])
  @@index([purgeAfter])
  @@map("videos")
}

model Challenge {
  id          String                @id @default(uuid())
  eventId     String
  categoryId  String?
  title       String
  description String?
  order       Int                   @default(0)
  isActive    Boolean               @default(true)
  isVisible   Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  completions ChallengeCompletion[]
  category    Category?             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  event       Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([categoryId])
  @@index([isActive])
  @@map("challenges")
}

model QrDesign {
  id           String   @id @default(uuid())
  eventId      String   @unique
  templateSlug String?
  format       String?  @default("A6")
  headline     String?
  subline      String?
  eventName    String?
  callToAction String?
  bgColor      String?
  textColor    String?
  accentColor  String?
  logoUrl      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([eventId])
  @@map("qr_designs")
}

model PrintServiceSettings {
  id           String   @id @default(uuid())
  enabled      Boolean  @default(false)
  wordpressUrl String?
  productIdA6  String?
  productIdA5  String?
  priceA6      Float?
  priceA5      Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("print_service_settings")
}

model ChallengeCompletion {
  id            String            @id @default(uuid())
  challengeId   String
  photoId       String            @unique
  guestId       String?
  uploaderName  String?
  ratingCount   Int               @default(0)
  averageRating Float?
  completedAt   DateTime          @default(now())
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  challenge     Challenge         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  guest         Guest?            @relation(fields: [guestId], references: [id])
  photo         Photo             @relation(fields: [photoId], references: [id], onDelete: Cascade)
  ratings       ChallengeRating[]

  @@index([challengeId])
  @@index([photoId])
  @@index([guestId])
  @@map("challenge_completions")
}

model ChallengeRating {
  id           String              @id @default(uuid())
  completionId String
  raterGuestId String?
  raterName    String?
  ipAddress    String?
  rating       Int
  createdAt    DateTime            @default(now())
  completion   ChallengeCompletion @relation(fields: [completionId], references: [id], onDelete: Cascade)

  @@unique([completionId, ipAddress])
  @@index([completionId])
  @@map("challenge_ratings")
}

model Invitation {
  id           String                @id @default(uuid())
  eventId      String
  slug         String                @unique
  name         String
  config       Json?                 @default("{}")
  passwordHash String?
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  visibility   InvitationVisibility  @default(UNLISTED)
  rsvps        InvitationRsvp[]
  shortLinks   InvitationShortLink[]
  visits       InvitationVisit[]
  event        Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([slug])
  @@index([visibility])
  @@index([isActive])
  @@map("invitations")
}

model InvitationRsvp {
  id           String               @id @default(uuid())
  invitationId String
  status       InvitationRsvpStatus
  name         String?
  ipHash       String?
  userAgent    String?
  createdAt    DateTime             @default(now())
  invitation   Invitation           @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@index([invitationId])
  @@index([status])
  @@index([createdAt])
  @@map("invitation_rsvps")
}

model InvitationShortLink {
  id             String            @id @default(uuid())
  invitationId   String
  code           String            @unique
  channel        String?
  createdAt      DateTime          @default(now())
  lastAccessedAt DateTime?
  invitation     Invitation        @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  visits         InvitationVisit[]

  @@index([invitationId])
  @@index([code])
  @@map("invitation_short_links")
}

model InvitationVisit {
  id           String               @id @default(uuid())
  invitationId String
  shortLinkId  String?
  ipHash       String?
  userAgent    String?
  createdAt    DateTime             @default(now())
  invitation   Invitation           @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  shortLink    InvitationShortLink? @relation(fields: [shortLinkId], references: [id])

  @@index([invitationId])
  @@index([shortLinkId])
  @@index([createdAt])
  @@map("invitation_visits")
}

model InvitationTemplate {
  id          String   @id @default(uuid())
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  slug        String   @unique
  title       String
  description String?
  html        String?
  text        String?

  @@index([slug])
  @@index([isActive])
  @@map("invitation_templates")
}

model ImpersonationAuditLog {
  id           String   @id @default(uuid())
  adminUserId  String
  targetUserId String
  reason       String?
  ttlSeconds   Int
  ipHash       String?
  userAgent    String?
  createdAt    DateTime @default(now())
  adminUser    User     @relation("ImpersonationAuditAdmin", fields: [adminUserId], references: [id], onDelete: Cascade)
  targetUser   User     @relation("ImpersonationAuditTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("impersonation_audit_logs")
}

model EmailTemplate {
  id        String            @id @default(uuid())
  kind      EmailTemplateKind @unique
  name      String
  subject   String
  html      String?
  text      String?
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([kind])
  @@index([isActive])
  @@map("email_templates")
}

model CmsContentSnapshot {
  id          String         @id @default(uuid())
  kind        CmsContentKind
  slug        String
  title       String
  html        String?
  excerpt     String?
  sourceUrl   String
  link        String?
  modifiedGmt String?
  fetchedAt   DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([kind, slug])
  @@index([kind])
  @@index([slug])
  @@index([fetchedAt])
  @@map("cms_content_snapshots")
}

model ApiKey {
  id          String           @id @default(uuid())
  name        String
  prefix      String           @unique
  keyHash     String           @unique
  scopes      String[]         @default([])
  status      ApiKeyStatus     @default(ACTIVE)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdById String?
  revokedAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  audits      ApiKeyAuditLog[]
  createdBy   User?            @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([prefix])
  @@index([createdById])
  @@index([expiresAt])
  @@map("api_keys")
}

model ApiKeyAuditLog {
  id        String            @id @default(uuid())
  apiKeyId  String?
  action    ApiKeyAuditAction
  scope     String?
  path      String?
  ipHash    String?
  userAgent String?
  message   String?
  createdAt DateTime          @default(now())
  apiKey    ApiKey?           @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId])
  @@index([action])
  @@index([createdAt])
  @@map("api_key_audit_logs")
}

model FaceSearchConsent {
  id            String                      @id @default(uuid())
  eventId       String
  ipHash        String?
  userAgent     String?
  consentKey    String?
  noticeText    String?
  checkboxLabel String?
  expiresAt     DateTime
  revokedAt     DateTime?
  createdAt     DateTime                    @default(now())
  updatedAt     DateTime                    @updatedAt
  audits        FaceSearchConsentAuditLog[]
  event         Event                       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("face_search_consents")
}

model FaceSearchConsentAuditLog {
  id            String                  @id @default(uuid())
  consentId     String?
  eventId       String
  action        FaceSearchConsentAction
  ipHash        String?
  userAgent     String?
  consentKey    String?
  noticeText    String?
  checkboxLabel String?
  createdAt     DateTime                @default(now())
  consent       FaceSearchConsent?      @relation(fields: [consentId], references: [id])
  event         Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([consentId])
  @@index([eventId])
  @@index([action])
  @@index([createdAt])
  @@map("face_search_consent_audit_logs")
}

model InvoiceRecord {
  id          String        @id @default(uuid())
  source      InvoiceSource @default(WOOCOMMERCE)
  status      InvoiceStatus @default(OPEN)
  wcOrderId   String?
  wpUserId    Int?
  eventId     String?
  currency    String        @default("EUR")
  amountCents Int
  issuedAt    DateTime      @default(now())
  payload     Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  event       Event?        @relation(fields: [eventId], references: [id])

  @@index([source])
  @@index([status])
  @@index([wcOrderId])
  @@index([wpUserId])
  @@index([eventId])
  @@index([issuedAt])
  @@map("invoice_records")
}

model design_projects {
  id               String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  event_id         String
  type             String
  name             String
  config           Json
  template_id      String?
  is_published     Boolean?          @default(false)
  is_draft         Boolean?          @default(true)
  version          Int?              @default(1)
  created_at       DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?         @default(now()) @db.Timestamptz(6)
  events           Event             @relation(fields: [event_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  design_templates design_templates? @relation(fields: [template_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([event_id])
  @@index([template_id])
  @@index([type])
}

model design_templates {
  id                String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  name              String
  description       String?
  type              String
  category          String
  preview_image_url String
  config            Json
  tags              String[]          @default([])
  is_premium        Boolean?          @default(false)
  popularity        Int?              @default(0)
  is_active         Boolean?          @default(true)
  created_at        DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?         @default(now()) @db.Timestamptz(6)
  design_projects   design_projects[]

  @@index([category])
  @@index([is_active])
  @@index([type])
}

model qr_templates {
  id               String   @id @default(uuid())
  slug             String   @unique
  name             String
  description      String?
  category         String   @default("MINIMAL")
  
  // SVG content per format
  svgA6            String?  @db.Text
  svgA5            String?  @db.Text
  svgStory         String?  @db.Text
  svgSquare        String?  @db.Text
  
  // Default colors
  defaultBgColor     String @default("#ffffff")
  defaultTextColor   String @default("#1a1a1a")
  defaultAccentColor String @default("#295B4D")
  
  // Metadata
  isPremium        Boolean  @default(false)
  isPublic         Boolean  @default(true)
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  previewUrl       String?
  
  // Legacy fields (keep for compatibility)
  templateImageUrl String?
  config           String?
  usageCount       Int      @default(0)
  rating           Float?   @db.Real
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt

  @@index([category])
  @@index([isPublic])
  @@index([isActive])
  @@index([sortOrder])
}

model MosaicWall {
  id                 String              @id @default(uuid())
  eventId            String              @unique
  targetImageUrl     String?
  targetImagePath    String?
  gridWidth          Int                 @default(24)
  gridHeight         Int                 @default(24)
  tileSizeMm         Int                 @default(50)
  boardWidthMm       Int?
  boardHeightMm      Int?
  gridColors         Json?
  overlayIntensity   Int                 @default(10)
  status             MosaicWallStatus    @default(DRAFT)
  fillMode           MosaicFillMode      @default(COLOR_MATCH)
  autoFillEnabled    Boolean             @default(true)
  autoFillThreshold  Int                 @default(85)
  displayAnimation   MosaicAnimation     @default(ZOOM_FLY)
  showTicker         Boolean             @default(true)
  showQrOverlay      Boolean             @default(true)
  nextPrintNumber    Int                 @default(1)
  sourceModes        String[]            @default(["GUEST_UPLOAD"])
  printEnabled       Boolean             @default(false)
  printConfirmation  Boolean             @default(false)
  reservationTimeout Int                 @default(15)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  event              Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tiles              MosaicTile[]
  printJobs          MosaicPrintJob[]

  @@index([eventId])
  @@index([status])
  @@map("mosaic_walls")
}

model MosaicTile {
  id               String            @id @default(uuid())
  mosaicWallId     String
  photoId          String?
  gridX            Int
  gridY            Int
  positionLabel    String
  croppedImageUrl  String?
  croppedImagePath String?
  dominantColor    Json?
  targetColor      Json?
  colorDistance     Float?
  isAutoFilled     Boolean           @default(false)
  isHero           Boolean           @default(false)
  printStatus      MosaicPrintStatus @default(PENDING)
  printNumber      Int?
  source           MosaicTileSource  @default(SMARTPHONE)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  mosaicWall       MosaicWall        @relation(fields: [mosaicWallId], references: [id], onDelete: Cascade)
  photo            Photo?            @relation(fields: [photoId], references: [id], onDelete: SetNull)
  printJob         MosaicPrintJob?

  @@unique([mosaicWallId, gridX, gridY])
  @@index([mosaicWallId])
  @@index([photoId])
  @@index([printStatus])
  @@index([isAutoFilled])
  @@index([createdAt])
  @@map("mosaic_tiles")
}

enum MosaicWallStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum MosaicFillMode {
  COLOR_MATCH
  HYBRID
}

enum MosaicAnimation {
  PUZZLE
  FLIP
  PARTICLES
  ZOOM_FLY
  RIPPLE
}

enum MosaicPrintStatus {
  PENDING
  PRINTING
  PRINTED
  PLACED
}

enum MosaicTileSource {
  SMARTPHONE
  BOOTH
  ADMIN
  AUTO_FILL
  PRINT_TERMINAL
}

model MosaicPrintJob {
  id              String              @id @default(uuid())
  wallId          String
  photoId         String
  tileId          String?             @unique
  pinCode         String
  qrPayload       String
  status          MosaicPrintJobStatus @default(PENDING)
  gridX           Int?
  gridY           Int?
  reservedAt      DateTime?
  printedAt       DateTime?
  expiresAt       DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  wall            MosaicWall          @relation(fields: [wallId], references: [id], onDelete: Cascade)
  photo           Photo               @relation(fields: [photoId], references: [id], onDelete: Cascade)
  tile            MosaicTile?         @relation(fields: [tileId], references: [id], onDelete: SetNull)

  @@unique([wallId, pinCode])
  @@index([wallId])
  @@index([photoId])
  @@index([status])
  @@index([pinCode])
  @@index([expiresAt])
  @@map("mosaic_print_jobs")
}

enum MosaicPrintJobStatus {
  PENDING
  PRINTING
  PRINTED
  EXPIRED
}

enum UserRole {
  ADMIN
  PARTNER
  HOST
}

enum EventMemberRole {
  COHOST
}

enum QaLogLevel {
  IMPORTANT
  DEBUG
}

enum EntitlementStatus {
  ACTIVE
  REPLACED
  CANCELLED
}

enum PackageDefinitionType {
  BASE
  ADDON
  UPGRADE
}

enum WooWebhookProvider {
  WOOCOMMERCE
}

enum WooWebhookLogStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
  FORBIDDEN
}

enum GuestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum PhotoStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EntryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VideoStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

enum InvitationVisibility {
  UNLISTED
  PUBLIC
}

enum InvitationRsvpStatus {
  YES
  NO
  MAYBE
}

enum EmailTemplateKind {
  INVITATION
  STORAGE_ENDS_REMINDER
  PHOTO_NOTIFICATION
}

enum CmsContentKind {
  pages
  posts
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum ApiKeyAuditAction {
  CREATED
  REVOKED
  USED
  FAILED
}

enum FaceSearchConsentAction {
  ACCEPTED
  REVOKED
}

// ─── PARTNER / FRANCHISE MODEL ───────────────────────────────────────────────

model Partner {
  id              String          @id @default(uuid())
  name            String
  slug            String          @unique
  tier            PartnerTier     @default(BRANDED)
  status          PartnerStatus   @default(ACTIVE)
  contactEmail    String
  contactPhone    String?
  companyName     String?
  taxId           String?
  // Branding (white-label tier)
  logoUrl         String?
  primaryColor    String?         @default("#6366f1")
  accentColor     String?         @default("#10b981")
  customDomain    String?         @unique
  // Limits & config
  maxEvents       Int             @default(50)
  maxStorageGb    Int             @default(100)
  commissionPct   Float           @default(20)
  // Billing
  billingEmail    String?
  billingAddress  Json?
  // Metadata
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  // Relations
  members         PartnerMember[]
  events          Event[]
  hardware        PartnerHardware[]
  billingPeriods  BillingPeriod[]

  @@map("partners")
}

model PartnerMember {
  id          String              @id @default(uuid())
  partnerId   String
  userId      String
  role        PartnerMemberRole   @default(OPERATOR)
  createdAt   DateTime            @default(now())
  partner     Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([partnerId, userId])
  @@index([partnerId])
  @@index([userId])
  @@map("partner_members")
}

model PartnerHardware {
  id            String    @id @default(uuid())
  partnerId     String
  type          String    // e.g. 'PRINT_TERMINAL', 'PHOTO_BOOTH', 'DISPLAY'
  serialNumber  String?   @unique
  name          String
  status        String    @default("AVAILABLE") // AVAILABLE, ASSIGNED, MAINTENANCE
  assignedEventId String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  partner       Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([assignedEventId])
  @@map("partner_hardware")
}

enum PartnerTier {
  BRANDED      // Works under gästefotos.com branding
  WHITE_LABEL  // Own branding, custom domain
}

enum PartnerStatus {
  ACTIVE
  SUSPENDED
  TRIAL
}

enum PartnerMemberRole {
  OWNER       // Full access, billing
  MANAGER     // Manage events, hardware
  OPERATOR    // Operate events on-site
}

// ─── PARTNER BILLING ─────────────────────────────────────────────────────────

model BillingPeriod {
  id              String              @id @default(uuid())
  partnerId       String
  periodStart     DateTime
  periodEnd       DateTime
  status          BillingPeriodStatus @default(DRAFT)
  // Computed totals
  totalEvents     Int                 @default(0)
  totalPhotos     Int                 @default(0)
  totalPrintJobs  Int                 @default(0)
  totalRevenue    Float               @default(0)     // gross revenue
  commissionPct   Float               @default(20)    // snapshot of partner's rate
  commissionAmount Float              @default(0)     // totalRevenue * commissionPct / 100
  partnerPayout   Float               @default(0)     // totalRevenue - commissionAmount
  // Payment
  paidAt          DateTime?
  invoiceNumber   String?             @unique
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  // Relations
  partner         Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  lineItems       BillingLineItem[]

  @@index([partnerId])
  @@index([periodStart, periodEnd])
  @@map("billing_periods")
}

model BillingLineItem {
  id              String          @id @default(uuid())
  billingPeriodId String
  type            String          // EVENT_FEE, PRINT_JOB, STORAGE, CUSTOM
  description     String
  quantity        Int             @default(1)
  unitPrice       Float           @default(0)
  total           Float           @default(0)
  eventId         String?
  createdAt       DateTime        @default(now())
  billingPeriod   BillingPeriod   @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)

  @@index([billingPeriodId])
  @@map("billing_line_items")
}

enum BillingPeriodStatus {
  DRAFT
  FINALIZED
  SENT
  PAID
  CANCELLED
}

enum InvoiceSource {
  WOOCOMMERCE
  MANUAL
}

enum InvoiceStatus {
  OPEN
  PAID
  VOID
  REFUNDED
}
